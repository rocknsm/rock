---
- name: Make sure cluster is green
  uri:
    url: "http://{{ ansible_hostname }}:9200/_cluster/health"
    return_content: true
    timeout: 2
  register: result
  until: result.json.status == "green"
  retries: 300
  delay: 3
  run_once: true

- fail:
    msg: Elasticsearch cluster has a red status
  when: result.json.status == "red"

- name: Check for default mapping template
  uri:
    method: "GET"
    url: "http://{{ ansible_hostname }}:9200/_template/default"
  changed_when: false
  register: default_index_template
  run_once: true

- name: Load default elasticsearch mapping template
  uri:
    method: PUT
    url: "http://{{ ansible_hostname }}:9200/_template/default"
    body: "{{ lookup('file', 'default-mapping.json')}}"
    body_format: json
  when: ('elasticsearch' in installed_services) and default_index_template.status != 200
  run_once: true

- name: Blanket install/update elasticsearch mappings
  command: ./import-index-templates.sh "{{ es_url }}:"
  args:
    chdir: "{{ rock_module_dir }}/configuration/elasticsearch"
  changed_when: false
  run_once: true
...
